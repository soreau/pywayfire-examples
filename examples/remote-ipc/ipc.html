<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wayfire Web (Internal Process Commands)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }
      #output {
        white-space: pre-wrap;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        background-color: #fff;
        max-width: 800px;
        width: 100%;
        overflow: auto;
      }
      .window-info {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fafafa;
      }
      .form-control, .form-select {
        margin-bottom: 20px;
      }
      .error {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Wayfire (IPC)</h1>
      <div class="form-group mb-3">
        <select id="selectInput" class="form-select"></select>
        <input
          type="text"
          class="form-control mb-3"
          id="argInput"
          placeholder="<optional method arguments>"
        />
      </div>
      <div class="form-group mb-3">
        <label id="connectFailedLabel" class="error form-label">Failed to connect to server address.</br></label>
        <label id="IpPortLabel" for="IpPortInput" class="form-label">Enter IP and Port:</label>
        <input
          type="text"
          class="form-control mb-3"
          id="IpPortInput"
          placeholder="e.g., 127.0.0.1:8787"
        />
      </div>
      <div class="d-grid gap-2">
        <button id="sendCmdButton" class="btn btn-primary">Send Command</button>
      </div>
      <div class="d-grid gap-2">
        <button id="sendIpPortButton" class="btn btn-primary">Connect</button>
      </div>
      <div id="output" class="mt-4"></div>
    </div>

    <script>
      const outputDiv = document.getElementById("output");
      const selectInput = document.getElementById("selectInput");
      const argInput = document.getElementById("argInput");
      const sendCmdButton = document.getElementById("sendCmdButton");
      const connectFailedLabel = document.getElementById("connectFailedLabel");
      const IpPortInput = document.getElementById("IpPortInput");
      const IpPortLabel = document.getElementById("IpPortLabel");
      const sendIpPortButton = document.getElementById("sendIpPortButton");
      var gsocket = ipc_connect("localhost:8787");
      var list_methods = true;

      function send_command() {
        const args = argInput.value.trim();
        var command = selectInput.value.trim();
        if (args) {
           console.log("appending args: \"" + args + "\"");
           command += " " + args;
        }
        if (command) {
          if (command == "list_methods")
          {
              list_methods = true;
          }
          gsocket.send(command);
        } else {
          alert("Please enter a command");
        }
      }

      sendCmdButton.addEventListener("click", function () {
        send_command();
      });

      function ipc_connect(address) {
        const socket = new WebSocket("ws://" + address);

        socket.addEventListener("open", function (event) {
          outputDiv.innerHTML = ``;
          console.log("Connected to the server");
          selectInput.style.display = 'block';
          argInput.style.display = 'block';
          sendCmdButton.style.display = 'block';
          IpPortInput.style.display = 'none';
          IpPortLabel.style.display = 'none';
          connectFailedLabel.style.display = 'none';
          sendIpPortButton.style.display = 'none';
          socket.send("list_methods");
        });

        socket.addEventListener("message", function (event) {
          console.log("Raw message from server:", event.data);

          let data;
          try {
            data = JSON.parse(event.data);
          } catch (e) {
            console.error("Error parsing JSON:", e.message);
            outputDiv.innerHTML = `
            <p class="error">Error parsing message: ${e.message}</p>
            <pre>${event.data}</pre>
          `;
            return;
          }

          if (list_methods) {
            var message = [];
            while (selectInput.options.length > 0) {
              selectInput.remove(0);
            }
            var opt = document.createElement('option');
            opt.value = "";
            opt.innerHTML = "Please select method";
            selectInput.appendChild(opt);
            for (var key in data) {
              var cmd = data[key].split("/").pop();
              if (cmd[0] == "_" && cmd[1] == "_") {
                continue;
              }
              console.log(cmd);
              opt = document.createElement('option');
              opt.value = cmd;
              opt.innerHTML = cmd;
              selectInput.appendChild(opt);
              message.push(cmd);
            }
            list_methods = false;
            outputDiv.innerHTML = `<pre>${message.join().replaceAll(",", "\n")}</pre>`;
            return;
	  }

          outputDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        });

        socket.addEventListener("error", function (event) {
          console.error("WebSocket error:", event);
          outputDiv.innerHTML = `<p class="error">Error: ${event.message}</p>`;
        });

        socket.addEventListener("close", function (event) {
          console.log("WebSocket connection closed");
          outputDiv.innerHTML = `<p>Connection closed</p>`;
          selectInput.style.display = 'none';
          argInput.style.display = 'none';
          sendCmdButton.style.display = 'none';
          IpPortInput.style.display = 'block';
          IpPortLabel.style.display = 'block';
          connectFailedLabel.style.display = 'block';
          sendIpPortButton.style.display = 'block';
          sendIpPortButton.addEventListener("click", function () {
            const address = IpPortInput.value.trim();
            gsocket = ipc_connect(address);
          });
        });

        return socket;
      }
    </script>
  </body>
</html>
